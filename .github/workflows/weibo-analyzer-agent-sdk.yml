name: å¾®åšçƒ­æœåˆ†æ (Claude Agent SDK)

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š9ç‚¹å’Œæ™šä¸Š9ç‚¹æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´ = UTC+8ï¼‰
    # UTC 1:00 = åŒ—äº¬æ—¶é—´ 9:00
    # UTC 13:00 = åŒ—äº¬æ—¶é—´ 21:00
    - cron: '0 1,13 * * *'

  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      max_topics:
        description: 'åˆ†æçš„çƒ­æœæ•°é‡'
        required: false
        default: '15'
        type: string

jobs:
  analyze-weibo-hotspots:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º60åˆ†é’Ÿ

    steps:
    - name: ğŸ“¥ Checkout ä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºæäº¤

    - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'  # ç¼“å­˜ pip ä¾èµ–

    - name: ğŸ“¦ å®‰è£… Python ä¾èµ–
      run: |
        pip install --upgrade pip
        pip install requests anthropic

    - name: ğŸ¤– å®‰è£… Claude Agent SDK
      run: |
        # æ–¹å¼1: å¦‚æœ SDK å·²å‘å¸ƒåˆ° PyPI
        # pip install claude-agent-sdk

        # æ–¹å¼2: ä» GitHub å®‰è£…ï¼ˆæ¨èï¼‰
        pip install git+https://github.com/anthropics/anthropic-sdk-python.git

        # éªŒè¯å®‰è£…
        python -c "import anthropic; print(f'Anthropic SDK version: {anthropic.__version__}')"

    - name: ğŸ” æ‰§è¡Œå¾®åšçƒ­æœåˆ†æ
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
        TIANAPI_KEY: ${{ secrets.TIANAPI_KEY }}
        MAX_TOPICS: ${{ github.event.inputs.max_topics || '15' }}
      run: |
        echo "ğŸš€ å¼€å§‹æ‰§è¡Œå¾®åšçƒ­æœåˆ†æ..."
        echo "ğŸ“Š åˆ†æè¯é¢˜æ•°é‡: $MAX_TOPICS"
        python run_agent_sdk_analyzer.py

    - name: ğŸ“Š ç”Ÿæˆåˆ†ææŠ¥å‘Š
      if: success()
      run: |
        echo "ğŸ“ ç”Ÿæˆ HTML æŠ¥å‘Š..."
        python generate_enhanced_report.py

        # åˆ›å»º index.html ä½œä¸º GitHub Pages å…¥å£
        LATEST_HTML=$(ls -t output/weibo_hotspot_analysis_enhanced_*.html | head -1)
        if [ -f "$LATEST_HTML" ]; then
          cp "$LATEST_HTML" output/index.html
          echo "âœ… å·²åˆ›å»º index.html: $LATEST_HTML"
        else
          echo "âš ï¸ æœªæ‰¾åˆ° HTML æŠ¥å‘Šæ–‡ä»¶"
        fi

    - name: ğŸ“ åˆ›å»ºæŠ¥å‘Šå½’æ¡£
      if: success()
      run: |
        # åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„å½’æ¡£ç›®å½•
        ARCHIVE_DIR="archives/$(date +'%Y/%m')"
        mkdir -p "$ARCHIVE_DIR"

        # å¤åˆ¶æœ€æ–°æŠ¥å‘Šåˆ°å½’æ¡£
        cp output/weibo_hotspot_analysis_enhanced_*.html "$ARCHIVE_DIR/" || true

        # åªä¿ç•™æœ€è¿‘30å¤©çš„å½’æ¡£
        find archives/ -name "*.html" -mtime +30 -delete || true

    - name: ğŸ’¾ æäº¤æŠ¥å‘Šåˆ°ä»“åº“
      if: success()
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions Bot"

        # æ·»åŠ æ‰€æœ‰å˜æ›´
        git add output/*.html
        git add archives/
        git add *.json

        # æäº¤ï¼ˆå¦‚æœæœ‰å˜æ›´ï¼‰
        if git diff --staged --quiet; then
          echo "ğŸ“­ æ²¡æœ‰æ–°çš„å˜æ›´éœ€è¦æäº¤"
        else
          git commit -m "ğŸ¤– è‡ªåŠ¨ç”Ÿæˆåˆ†ææŠ¥å‘Š - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ… æŠ¥å‘Šå·²æäº¤åˆ°ä»“åº“"
        fi

    - name: ğŸ“¤ ä¸Šä¼ æŠ¥å‘Šä¸º Artifact
      if: always()  # å³ä½¿å¤±è´¥ä¹Ÿä¸Šä¼ ï¼Œä¾¿äºè°ƒè¯•
      uses: actions/upload-artifact@v4
      with:
        name: weibo-analysis-report-${{ github.run_number }}
        path: |
          output/*.html
          *.json
        retention-days: 30

    - name: ğŸ“ˆ ç”Ÿæˆæ‰§è¡Œæ‘˜è¦
      if: always()
      run: |
        echo "## ğŸ“Š æ‰§è¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f "hotspot_analysis_results.json" ]; then
          TOTAL=$(jq 'length' hotspot_analysis_results.json)
          HIGH_SCORE=$(jq '[.[] | select(.total_score >= 80)] | length' hotspot_analysis_results.json)
          AVG_SCORE=$(jq '[.[].total_score] | add / length' hotspot_analysis_results.json)

          echo "- âœ… åˆ†æè¯é¢˜æ•°: $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”¥ é«˜åˆ†è¯é¢˜æ•° (â‰¥80åˆ†): $HIGH_SCORE" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“Š å¹³å‡è¯„åˆ†: $(printf '%.1f' $AVG_SCORE)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ† Top 5 çƒ­æœ" >> $GITHUB_STEP_SUMMARY
          jq -r '.[:5] | .[] | "- **\(.title)** (è¯„åˆ†: \(.total_score))"' hotspot_analysis_results.json >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ æœªæ‰¾åˆ°åˆ†æç»“æœæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ğŸš¨ å¤±è´¥é€šçŸ¥
      if: failure()
      run: |
        echo "âŒ åˆ†æä»»åŠ¡å¤±è´¥ï¼" >> $GITHUB_STEP_SUMMARY
        echo "è¯·æ£€æŸ¥æ—¥å¿—ä»¥è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY

  # å¯é€‰ï¼šéƒ¨ç½²åˆ° GitHub Pages
  deploy-to-pages:
    needs: analyze-weibo-hotspots
    if: success()
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: ğŸ“¥ Checkout ä»£ç 
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0  # è·å–å®Œæ•´å†å²

    - name: ğŸ”„ æ‹‰å–æœ€æ–°æäº¤
      run: |
        git pull origin main
        echo "âœ… å·²æ‹‰å–æœ€æ–°æäº¤"
        ls -la output/ || echo "âš ï¸ output ç›®å½•ä¸å­˜åœ¨"

    - name: ğŸŒ é…ç½® GitHub Pages
      uses: actions/configure-pages@v4

    - name: ğŸ“¤ ä¸Šä¼ åˆ° Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: './output'

    - name: ğŸš€ éƒ¨ç½²åˆ° GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
